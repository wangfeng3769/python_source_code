<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>登陆</title>
	<script type="text/javascript" src="js/juicer-min.js"></script>
	<script type="text/javascript" src="js/until.base.js"></script>
	<script type="text/javascript" src="js/zepto.min.js"></script>
	<link href="css/index.css" rel="stylesheet" type="text/css" />
	<style>
a{color:#4F4F4F;text-decoration:none;}

.anniu-1:active{ background:url(img/bt-2.png) no-repeat; color:#3A434A;}
.fanhui-bt:active{ background:url(img/fanhui-2.jpg) no-repeat; color:#DD5523;}
.anniu-3:active{ background:url(img/bt2-2.jpg) no-repeat; color:#fff;}
.dl-bt-2-1:active{ background:url(img/zc-bt-0.jpg) no-repeat; color:#fff;}

.youce-bt-3:active{ background:url(img/yc-bt-3-2.jpg) no-repeat; color:#fff;}
.fanye-1:active{ background:#F86834; color:#fff;}
.tuichu:active{color:#F56833;}
</style>
</head>

<body>

<div class="dynamite-container">
	<div class="init" page="init">
		<div class="shouye">
			<div class="shouye-title">
				<img src="img/logo-1.jpg"/>
			</div>
			<div class="shouye-pic car-img-list">
				<div class="shouye-pic car-img-list">
					<div style="height:20px;"></div>
					<div class="shouye-pic-1">
						<a href="javascript:Until.getCars();">
							<img src="img/car-pic-1.jpg"></a>
					</div>
					<div style="height:20px;"></div>
					<div class="shouye-pic-1">
						<a href="javascript:Untile.getCars();">
							<img src="img/car-pic-2.jpg"></a>
					</div>
				</div>
			</div>

			<div class="tishi">
				<p class="tishi-1">帮助：选择您要预订的车辆，点击图片进入详细订车页。</p>
			</div>
		</div>

	</div>

</div>


<script id="book-time-info-tpl" type="text/template">
<div class="shouye book-car-page" page="book-car-page">
	<div class="shouye-title">
		<a href="javascript:void(0);" class="fanhui-bt goback-button">返回</a>
		<p class="title">订车</p>
	</div>
	<div style="height:5px;"></div>
		{#时间轴}
	<div class="shijianzhou">
		<p class="zhuangtai-1">已被预订</p>
		<p class="zhuangtai-2">可以预订</p>
		{@each i in range(0,3)}
		<div class="shijianzhou-1">
			<p class="riqi">${i|get_now_Ymd}</p>
			<span class="shijianzhou-1-1">
			</span>
			<ul>
				<li>0:00</li>
				<li>3:00</li>
				<li>6:00</li>
				<li>9:00</li>
				<li>12:00</li>
				<li>15:00</li>
				<li>18:00</li>
				<li>21:00</li>
			</ul>
		</div>

	{@/each}

	</div>
	{#时间轴end}
	<div style="height:5px;"></div>
	{#时间选择器}
	
	<div class="shijianzhou" style="height:90px;">
		{#取车时间}
		<span  class="sj-1  select-start" style=" height:36px;border-bottom:1px solid #ddd;">
			<p class="sj-1-txt" style="width:70px;">取车时间：</p>
			<select name="select-start-date" class="xiala select-date date-time-select" style="width:61px;">
			{@each i in range(0,3)}
				<option value="${i|get_now_Ymd}">${i|get_now_date}</option>
			{@/each}
			</select>
			<p class="sj-1-txt" style="width:20px;">日</p>
			<select name="select-start-hour" class="xiala select-hour date-time-select" style="width:46px;">

			{@each i in range(0,24)}
				<option value="${i|get_select_hour}">${i|get_select_hour}</option>
			{@/each}
			</select>

			<p class="sj-1-txt" style="width:20px;">时</p>
			<select name="select-start-min" class="xiala select-min date-time-select" style="width:46px;">
			{@each i in range(0,6)}
				<option value="${i|get_select_minute}" >${i|get_select_minute}</option>
			{@/each}
			</select>
			<p class="sj-1-txt" style="width:20px;">分</p>
			<input type="text" value="" class="start_time" style="display:none;">
		</span>

		{#还车时间}
		<span  class="sj-1 select-end" style=" height:36px;border-bottom:1px solid #ddd;">
			<p class="sj-1-txt" style="width:70px;">还车时间：</p>
			<select name="select-end-date" class="xiala select-date date-time-select" style="width:61px;">
			{@each i in range(0,3)}
				<option value="${i|get_now_Ymd}">${i|get_now_date}</option>
			{@/each}
			</select>
			<p class="sj-1-txt" style="width:20px;">日</p>
			<select name="select-end-hour" class="xiala select-hour date-time-select" style="width:46px;">

			{@each i in range(0,24)}
				<option value="${i|get_select_hour}">${i|get_select_hour}</option>
			{@/each}
			</select>

			<p class="sj-1-txt" style="width:20px;">时</p>
			<select name="select-end-min" class="xiala select-min date-time-select" style="width:46px;">
			{@each i in range(0,6)}
				<option value="${i|get_select_minute}" >${i|get_select_minute}</option>
			{@/each}
			</select>
			<p class="sj-1-txt" style="width:20px;">分</p>
			<input type="text" value="" class="end_time" style="display:none;">
		</span>
	</div>
	
	{#事件选择器end}

	<div style="height:5px;"></div>
			<div class="yongtu">
				<p class="sj-1-txt" style="width:50px; margin-left:10px;">用途：</p>
				<textarea name="reason" cols="" rows="3" class="shuru-2"></textarea>
				<a href="javascript:void(0)" class="anniu-3 submi-order-click">确定</a>
			</div>

			<div class="tishi" style="height:110px;">
				<p class="tishi-1">
					帮助：请选择您要取车和还车的时间，并填写订车的用途。
	点击确认按钮提交。时间轴为您显示该车三天内的预订情况，
	灰色部分为已预订，不可重复预订。
				</p>
			</div>
		</div>

</script>

<script id="car-img-list-tpl" type="text/template">
	<div class="shouye car-list" page="car-list">
		<div class="shouye-title">
			<img src="img/logo-1.jpg"/>
		</div>
		<div class="shouye-pic car-img-list">
		{@each cars as car}
			<div style="height:20px;"></div>
			<div class="shouye-pic-1">
				<a href="${car.id|get_bookcar_url}">
					<img src="${car.icon|get_img_url}"/>
				</a>
			</div>	
		{@/each}
		</div>

		<div class="tishi">
			<p class="tishi-1">帮助：选择您要预订的车辆，点击图片进入详细订车页。</p>
		</div>
	</div>
</script>


<script type="text/template" id="verify-order-tpl">
	<div class="shouye verify-page" page="verify-page">
		<div class="shouye-title">
			<a href="javascript:void(0)" class="fanhui-bt goback-button">返回</a>
			<p class="title">确认预订</p>
		</div>
		<div style="height:10px;"></div>
		<div class="tishi-2">
			<img src="img/tishi-pic.jpg"/>
			<p class="tishi-txt">请确认以下信息后提交预订！</p>
		</div>
		<div style="height:10px;"></div>
		<div class="shijianzhou" style="width:300px; height:255px;">
			<p style="height:15px;"></p>
			<p class="dingdan-xinxi" style="border-bottom:2px solid #ddd;">驾驶用户姓名：${uname}</p>
			<p style="height:9px;"></p>
			<p class="dingdan-xinxi">取车时间：${start_time}</p>
			<p style="height:5px;"></p>
			<p class="dingdan-xinxi">还车时间：${end_time}</p>
			<p style="height:5px;"></p>
			<p class="dingdan-xinxi">车牌号：${number}</p>
			<p style="height:5px;"></p>
			<p class="dingdan-xinxi" style="word-break:break-all;  word-wrap:break-word;">用途：${reason}</p>
			<p style="width:300px; margin:0 auto;">
				<input type="text" value="${start_time}" class="start_time" style="display:none;">
				<input type="text" value="${end_time}" class="end_time" style="display:none;">
				<textarea name="reason" cols="" value="${reason}" rows="3" class="shuru-2"style="display:none;">${reason}</textarea>
				<a href="javascript:void(0);" class="anniu-4 create-order-click" style="margin-left:47px;">确定</a>
				<a href="javascript:void(0);" class="anniu-4 goback-button" style="margin-left:10px;">取消</a>
			</p>
		</div>
		<div style="height:25px;"></div>

		<div class="tishi" style="height:160px;">
			<p class="tishi-1">
				<img src="img/queren-pic.jpg"/>
			</p>
		</div>
	</div>
</script>

<script type="text/javascript">
$(function(){
	Until.init();
	// G.carId=Until.getRequest('carid');
 // 	if (G.carId==null||G.carId==undefined)
	// {
	// 	window.location.href='index.html';

	// }
	// else{
	// 	getCarInfo(G.carId);
	// }
})

//获取车辆信息
function getCarInfo(carId)
{
	G.carId=carId;
	Until.postJson(G.memberApi,{item:'twGetCarInfo',car_id:carId},function(data){
		if (data.errno==4060||data.errno==4020)
		{
			Until.showNotice({msg:'未登录,请登录',url:'login.html'});
			// window.location.href='login.html';
		}
		else
		{
			
			if (data.errno==2000)
			{
				//页面初始化的动作应该在这里
				// Until.renderHTML($('#book-time-info-tpl'),data.content,$('#content'));
				Until.jumpNewPage(data.content,$('#book-time-info-tpl'));
				initTimeLine(data.content.car.orderTime);
				G.car=data.content.car;
				pageCarInfoInit();
			}

		}
	});

	function pageCarInfoInit()
	{
		selectDateTimeInit();
		submitInit();
		buttonInit();
	}

	function buttonInit()
	{
		$('.goback-button').live('click',function(e){
			Until.goback(e);
		});
	}
	//时间轴显示
	function initTimeLine(orderTimeArr)
	{		
		var targets=$('.shijianzhou-1-1');
		Until.timeLineToos.defaultData.style='shijianzhou-1-2';
		for(i in orderTimeArr)
		{
			if (orderTimeArr[i]!=null||orderTimeArr[i]!=undefined)
			{
				Until.timeLineToos.addTimeLine($(targets[i]),orderTimeArr[i]);
			};			
		}
	}

		//日期时间选择初始化
	function selectDateTimeInit()
	{
		$('.date-time-select').live('change',function(e){
			updateDateTime($(this).parent());
		})

		updateDateTime($('.select-start'));
		updateDateTime($('.select-end'));
		function updateDateTime(jqFormObj)
		{
			var dateTime=synthesizeDateTime(jqFormObj);
			// alert(dateTime);
			jqFormObj.find('input').val(dateTime);
		}

		function synthesizeDateTime(jqFormObj)
		{
			var selectDate=jqFormObj.find('.select-date').val();
			var selectTime=jqFormObj.find('.select-hour').val()+':'+jqFormObj.find('.select-min').val();
			var dateTime=selectDate+' '+selectTime;
			return dateTime;
		}
	}


		//表单提交
	function submitInit()
	{
		$('.submi-order-click').click(function(){
			var param=getPostParam($(this));
			submitOrder(param);
		});
		$('.create-order-click').live('click',function(){
			var param=getPostParam($(this));
			createOrder(param);
		})
		$('textarea').bind('input',function(){
			var text=$(this).val();
			var limitLength=90
			if (getByteLen(text)>limitLength)
			{
				
				$(this).val(getByteVal(text,limitLength));
				Until.showMsg('最多只能输入17个字符');
			}
		});
		//返回val的字节长度 
		function getByteLen(val) {
			var len = 0;
			for (var i = 0; i < val.length; i++) {
				if (val[i].match(/[^\x00-\xff]/ig) != null) //全角 
				len += 2;
				else len += 1;
			}
			return len;
		}
		//返回val在规定字节长度max内的值 

		function getByteVal(val, max) {
			var returnValue = '';
			var byteValLen = 0;
			for (var i = 0; i < val.length; i++) {
				if (val[i].match(/[^\x00-\xff]/ig) != null) byteValLen += 2;
				else byteValLen += 1;
				if (byteValLen > max) break;
				returnValue += val[i];
			}
			return returnValue;
		}
		function getPostParam(clickObj)
		{
			var container=clickObj.parent().parent();
			var startTime = container.find('.start_time').val();
			var endTime=container.find('.end_time').val();
			var reason = container.find('textarea').val();
			var targetApi='calculateDeposit';
			return {item:targetApi,start_time:startTime,end_time:endTime,reason:reason,car_id:G.carId};
		}
		function submitOrder(param)
		{
			Until.singleAjax.run(G.memberApi,param,function(data){
				if (data.errno!=2000)
				{
					Until.showMsg(data.errstr);

				}
				else
				{
					var sureMsg=param;
					sureMsg.uname=G.user.userName;
					sureMsg.number=G.car.number;
					submitOrderCallback(sureMsg);
				}
			});
		}

		function createOrder(param)
		{
			param.item="twPayforOrder";
			Until.singleAjax.run(G.memberApi,param,function(data){
				if (data.errno!=2000)
				{
					Until.showMsg(data.errstr);
				}
				else
				{
					//提交成功,跳转到使用订单的页面;
					window.location.href="in-use.html";
				}
			});
		}
		function submitOrderCallback(sureMsg)
		{

			var endPageObj=$('#verify-order-tpl');
			Until.jumpNewPage(sureMsg,endPageObj);
			// $('.dynamite').append($('#verify-order-tpl').html());

		}


	}
}

</script>
</body>
</html>